generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

model profiles {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nickname               String?
  avatar_url             String?
  level                  Int?      @default(1)
  current_exp            Int?      @default(0)
  max_exp                Int?      @default(1000)
  stamina                Int?      @default(100)
  max_stamina            Int?      @default(100)
  total_area             Float?    @default(0)
  created_at             DateTime  @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  updated_at             DateTime  @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  club_id                String?   @db.Uuid
  xp                     Int?      @default(0)
  total_distance_km      Float?    @default(0)
  coins                  Int?      @default(0)
  faction                String?
  last_faction_change_at DateTime? @db.Timestamptz(6)
  invited_by             String?   @db.Uuid
  path_color             String?   @default("#3B82F6")
  fill_color             String?   @default("#3B82F6")
  province               String?
  referral_code          String?   @unique
  referrer_id            String?   @db.Uuid
  badges                 String[]  @default([])
  isProfilePublic        Boolean   @default(true) @map("is_profile_public")
  backgroundUrl          String?   @map("background_url")
  cover_url              String?
  allow_recommendations  Boolean?  @default(true)
  allow_direct_messages  String?   @default("EVERYONE") // EVERYONE, FRIENDS_ONLY, NONE
  api_key                String?   @unique // For external API access (iOS Shortcuts, Zapier, etc.)
  last_social_read_at    DateTime? @default(now()) @db.Timestamptz(6)

  challenges_challenges_creator_idToprofiles    challenges[]         @relation("challenges_creator_idToprofiles")
  challenges_challenges_target_idToprofiles     challenges[]         @relation("challenges_target_idToprofiles")
  club_members                                  club_members[]
  clubs_clubs_owner_idToprofiles                clubs[]              @relation("clubs_owner_idToprofiles")
  friendships_friendships_friend_idToprofiles   friendships[]        @relation("friendships_friend_idToprofiles")
  friendships_friendships_user_idToprofiles     friendships[]        @relation("friendships_user_idToprofiles")
  messages                                      messages[]
  notifications                                 notifications[]
  clubs_profiles_club_idToclubs                 clubs?               @relation("profiles_club_idToclubs", fields: [club_id], references: [id], onUpdate: NoAction)
  profiles_profiles_invited_byToprofiles        profiles?            @relation("profiles_invited_byToprofiles", fields: [invited_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_profiles_profiles_invited_byToprofiles  profiles[]           @relation("profiles_invited_byToprofiles")
  profiles_profiles_referrer_idToprofiles       profiles?            @relation("profiles_referrer_idToprofiles", fields: [referrer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_profiles_profiles_referrer_idToprofiles profiles[]           @relation("profiles_referrer_idToprofiles")
  room_participants                             room_participants[]
  rooms                                         rooms[]
  route_plans                                   route_plans[]
  runs                                          runs[]
  territories                                   territories[]
  training_plans                                training_plans[]
  user_city_progress                            user_city_progress[]
  user_season_stats                             user_season_stats[]
  user_achievements                             user_achievements[]
  user_badges                                   user_badges[]
  user_missions                                 user_missions[]
  user_task_logs                                user_task_logs[]
  profileLikesReceived                          profile_likes[]      @relation("profile_likes_user")
  profileLikesGiven                             profile_likes[]      @relation("profile_likes_liker")
  blockedByMe                                   blocked_users[]      @relation("blocked_users_blocker")
  blockedMe                                     blocked_users[]      @relation("blocked_users_blocked")
  userBackgrounds                               user_backgrounds[]
  userTaskProgress                              UserTaskProgress[]
  watchActivities                               watch_activities[]
  activity_likes                                activity_likes[]
  activity_comments                             activity_comments[]
  posts                                         posts[]
  post_likes                                    post_likes[]
  post_comments                                 post_comments[]
  post_reports                                  post_reports[]
  user_purchases                                user_purchases[]

  @@index([club_id], map: "idx_profiles_club_id")
  @@index([faction], map: "idx_profiles_faction")
  @@index([invited_by], map: "idx_profiles_invited_by")
  @@index([referrer_id])
  @@map("profiles")
  @@schema("public")
}

model DailyStat {
  id               String   @id @default(cuid())
  date             DateTime @unique
  redCount         Int
  blueCount        Int
  totalTerritories Int
  createdAt        DateTime @default(now())

  @@schema("public")
}

model route_plans {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String    @db.Uuid
  name           String?
  waypoints      Json?     @db.Json
  geometry       Json?     @db.Json
  distance       Float?    @default(0)
  estimated_time Int?      @default(0)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  capture_area   Float?    @default(0)
  profiles       profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model training_plans {
  id                 String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String               @db.Uuid
  goal               String?
  level              String?
  start_date         DateTime?            @db.Timestamptz(6)
  duration_weeks     Int?
  created_at         DateTime?            @default(now()) @db.Timestamptz(6)
  scheduled_workouts scheduled_workouts[]
  profiles           profiles             @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model seasons {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  start_date        DateTime            @db.Timestamptz(6)
  end_date          DateTime            @db.Timestamptz(6)
  is_active         Boolean             @default(false)
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)
  user_season_stats user_season_stats[]

  @@schema("public")
}

model user_season_stats {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id   String   @db.Uuid
  season_id String   @db.Uuid
  score     Int      @default(0)
  rank      Int?
  seasons   seasons  @relation(fields: [season_id], references: [id], onDelete: Cascade)
  profiles  profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, season_id])
  @@index([season_id])
  @@schema("public")
}

model scheduled_workouts {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  plan_id         String         @db.Uuid
  day_offset      Int?
  target_distance Float?
  target_pace     String?
  is_completed    Boolean?       @default(false)
  training_plans  training_plans @relation(fields: [plan_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([plan_id])
  @@schema("public")
}

model admin_logs {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  admin_id   String    @db.Uuid
  action     String
  target_id  String?   @db.Uuid
  details    String?

  @@index([admin_id])
  @@schema("public")
}

model app_admins {
  id         String    @id @db.Uuid
  role       String?   @default("moderator")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

model badges {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                    String        @unique
  name                    String
  description             String?
  icon_name               String?
  category                String?
  condition_value         Int?
  tier                    String?       @default("bronze")
  requirement_type        String?
  requirement_value       Decimal?      @db.Decimal
  icon_path               String?
  level                   String?
  requirement_description String?
  user_badges             user_badges[]

  @@schema("public")
}

model challenges {
  id                                       String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type                                     String
  creator_id                               String    @db.Uuid
  target_id                                String    @db.Uuid
  distance                                 Float?
  duration                                 String?
  reward_xp                                Int?      @default(0)
  status                                   String?   @default("pending")
  created_at                               DateTime  @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  expires_at                               DateTime? @db.Timestamptz(6)
  profiles_challenges_creator_idToprofiles profiles  @relation("challenges_creator_idToprofiles", fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_challenges_target_idToprofiles  profiles  @relation("challenges_target_idToprofiles", fields: [target_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([creator_id])
  @@index([target_id])
  @@schema("public")
}

model club_members {
  club_id   String   @db.Uuid
  user_id   String   @db.Uuid
  role      String?  @default("member")
  joined_at DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  status    String?  @default("pending")
  clubs     clubs    @relation(fields: [club_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles  profiles @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([club_id, user_id])
  @@index([user_id])
  @@schema("public")
}

model clubs {
  id                                String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                              String         @unique
  description                       String?
  owner_id                          String?        @db.Uuid
  created_at                        DateTime       @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  status                            club_status?   @default(pending)
  audit_reason                      String?
  province                          String?
  total_area                        Decimal?       @default(0) @db.Decimal
  avatar_url                        String?
  is_public                         Boolean?       @default(true)
  level                             String?        @default("1")
  rating                            Decimal?       @default(0) @db.Decimal
  member_count                      Int?           @default(1)
  territory                         String?        @default("0")
  club_members                      club_members[]
  profiles_clubs_owner_idToprofiles profiles?      @relation("clubs_owner_idToprofiles", fields: [owner_id], references: [id], onUpdate: NoAction)
  profiles_profiles_club_idToclubs  profiles[]     @relation("profiles_club_idToclubs")
  runs                              runs[]

  @@index([owner_id], map: "idx_clubs_owner_id")
  @@index([province])
  @@schema("public")
}

model ProvinceStat {
  id                 Int      @id @default(autoincrement())
  provinceName       String   @unique
  totalTerritoryArea Float
  updatedAt          DateTime @updatedAt

  @@schema("public")
}

model CityStat {
  id                 Int      @id @default(autoincrement())
  provinceName       String
  cityName           String
  totalTerritoryArea Float
  updatedAt          DateTime @updatedAt

  @@unique([provinceName, cityName])
  @@schema("public")
}

model faction_balance_configs {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  updated_at           DateTime? @default(now()) @db.Timestamptz(6)
  imbalance_threshold  Decimal?  @default(0.1) @db.Decimal
  underdog_multiplier  Decimal?  @default(1.0) @db.Decimal
  auto_balance_enabled Boolean?  @default(true)
  manual_buff_target   String?   @default("none")

  @@schema("public")
}

model FactionStatsCache {
  id         Int      @id @default(autoincrement())
  red_area   Float    @default(0)
  blue_area  Float    @default(0)
  updated_at DateTime @default(now()) @updatedAt

  @@schema("public")
}

model faction_stats_snapshot {
  id         String   @id
  blue_area  Float    @default(0)
  red_area   Float    @default(0)
  updated_at DateTime @default(now())

  @@schema("public")
}

model friendships {
  id                                       String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id                                  String   @db.Uuid
  friend_id                                String   @db.Uuid
  status                                   String?  @default("pending")
  created_at                               DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  profiles_friendships_friend_idToprofiles profiles @relation("friendships_friend_idToprofiles", fields: [friend_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_friendships_user_idToprofiles   profiles @relation("friendships_user_idToprofiles", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, friend_id])
  @@index([friend_id], map: "idx_friendships_friend_id")
  @@schema("public")
}

model messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @db.Uuid
  content    String?
  is_read    Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  sender_id  String?   @db.Uuid
  profiles   profiles? @relation(fields: [sender_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([sender_id], map: "idx_messages_sender_id")
  // @@index([user_id])
  @@index([user_id, is_read], map: "idx_messages_user_unread")
  @@schema("public")
}

model mission_configs {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  code          String    @unique
  title         String
  description   String?
  points_reward Int       @default(0)
  is_active     Boolean?  @default(true)
  frequency     String?   @default("daily")

  @@schema("public")
}

model missions {
  id                String          @id @default(dbgenerated("gen_random_uuid()"))
  title             String
  description       String?
  type              String
  target_value      Int?            @default(1)
  reward_amount     Int?            @default(100)
  created_at        DateTime?       @default(now()) @db.Timestamptz(6)
  frequency         String?         @default("one_time")
  reward_coins      Int?            @default(0)
  reward_xp         Int?            @default(0)
  target            Int?            @default(1)
  reward_experience Int?            @default(0)
  target_count      Int?            @default(1)
  user_missions     user_missions[]

  @@schema("public")
}

model notifications {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  title      String
  body       String?
  type       String?
  data       Json?
  is_read    Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model room_messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  room_id    String    @db.Uuid
  user_id    String    @db.Uuid
  content    String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  rooms      rooms     @relation(fields: [room_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([room_id])
  @@index([user_id])
  @@schema("public")
}

model room_participants {
  room_id         String   @db.Uuid
  user_id         String   @db.Uuid
  joined_at       DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  total_score     Int?     @default(0)
  territory_area  Decimal? @default(0.00) @db.Decimal(10, 2)
  territory_ratio Decimal? @default(0.00) @db.Decimal(5, 2)
  stolen_lands    Int?     @default(0)
  lost_lands      Int?     @default(0)
  rivals_defeated Int?     @default(0)
  growth_rate     Decimal? @default(0.00) @db.Decimal(5, 2)
  status          String?  @default("active")
  role            String?  @default("member")
  rooms           rooms    @relation(fields: [room_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles        profiles @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([room_id, user_id])
  @@index([room_id, territory_ratio(sort: Desc)], map: "idx_room_participants_ratio")
  @@index([room_id, total_score(sort: Desc)], map: "idx_room_participants_score")
  @@index([user_id])
  @@schema("public")
}

model rooms {
  id                      String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  host_id                 String?             @db.Uuid
  name                    String
  target_distance_km      Decimal?            @db.Decimal
  target_duration_minutes Int?
  max_participants        Int?                @default(10)
  is_private              Boolean?            @default(false)
  password                String?
  status                  String?             @default("waiting")
  created_at              DateTime            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  is_banned               Boolean?            @default(false)
  allow_chat              Boolean?            @default(true)
  icon_url                String?
  description             String?
  allow_imports           Boolean?            @default(true)
  avatar_url              String?
  category                String?
  invite_code             String?
  allow_member_invite     Boolean?            @default(true)
  room_messages           room_messages[]
  room_participants       room_participants[]
  profiles                profiles?           @relation(fields: [host_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([host_id], map: "idx_rooms_host_id")
  @@schema("public")
}

model runs {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String?           @db.Uuid
  club_id         String?           @db.Uuid
  area            Decimal           @default(0) @db.Decimal
  duration        Int               @default(0)
  province        String?
  created_at      DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?         @default(now()) @db.Timestamptz(6)
  status          String?           @default("active")
  path            Json?             @db.Json
  distance        Float?            @default(0)
  polygons        Json?             @default("[]") @db.Json
  source          String?           @default("phone") // "phone", "watch", "gpx", "manual"
  idempotency_key String?           @unique
  user_task_logs  user_task_logs[]
  watch_activity  watch_activities?
  clubs           clubs?            @relation(fields: [club_id], references: [id], onUpdate: NoAction)
  profiles        profiles?         @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([club_id], map: "idx_runs_club_id")
  @@index([user_id])
  @@schema("public")
}

model watch_activities {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String   @db.Uuid
  run_id         String?  @unique @db.Uuid // 1:1 关联，一个原始记录对应一个生成的 Run
  source         String   @default("watch") // "watch", "gpx", "manual", "gpx_upload"
  source_app     String? // Specific origin app: "HealthKit", "Strava", "Garmin", etc.
  external_id    String? // Unique ID from external system (e.g. HealthKit UUID, Garmin Activity ID)
  raw_points     Json     @db.Json
  summary        Json     @db.Json
  cleaned_points Json?    @db.Json
  raw_data       Json?    @db.Json // Full unprocessed original payload for debugging
  point_count    Int      @default(0)
  is_loop        Boolean  @default(false)
  loop_distance  Float? // distance between start/end in meters
  total_distance Float? // total path distance in meters
  territory_area Float? // area in m² if territory created
  status         String   @default("pending") // pending, processed, failed, warning
  error_message  String?
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  profiles profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)
  runs     runs?    @relation(fields: [run_id], references: [id], onDelete: SetNull)

  @@unique([user_id, external_id]) // Composite unique: one external activity per user
  @@index([user_id])
  @@index([external_id]) // For quick dedup lookups by source ID
  @@schema("public")
}

model user_task_logs {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.Uuid
  run_id       String?   @db.Uuid
  task_id      String
  type         String // 'DAILY' | 'WEEKLY' | 'ACHIEVEMENT'
  period_key   String // Idempotency key: "YYYY-MM-DD", "YYYY-Www", "PERMANENT"
  reward_coins Int       @default(0)
  reward_xp    Int       @default(0)
  completed_at DateTime? @default(now()) @db.Timestamptz(6)

  profiles profiles @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  runs     runs?    @relation(fields: [run_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([user_id, task_id, period_key])
  @@index([user_id])
  @@schema("public")
}

model territories {
  id                   String                   @id
  city_id              String
  owner_id             String                   @db.Uuid
  captured_at          DateTime?                @default(now()) @db.Timestamptz(6)
  last_maintained_at   DateTime?                @default(now()) @db.Timestamptz(6)
  health               Int?                     @default(1000)
  level                Int?                     @default(1)
  geojson              Unsupported("geometry")?
  h3_index             String?
  status               String?                  @default("active")
  owner_change_count   Int?                     @default(0)
  last_owner_change_at DateTime?                @db.Timestamptz(6)
  neutral_until        DateTime?                @db.Timestamptz(6)
  profiles             profiles                 @relation(fields: [owner_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  hp_logs              territory_hp_logs[]
  owner_change_logs    territory_owner_change_logs[]

  @@index([city_id], map: "idx_territories_city_id")
  @@index([owner_id], map: "idx_territories_owner_id")
  @@schema("public")
}

model user_achievements {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String?   @db.Uuid
  achievement_id String?
  unlocked_at    DateTime? @default(now()) @db.Timestamptz(6)
  profiles       profiles? @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id], map: "idx_user_achievements_user_id")
  @@schema("public")
}

model user_badges {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id   String    @db.Uuid
  badge_id  String    @db.Uuid
  earned_at DateTime? @default(now()) @db.Timestamptz(6)
  badges    badges    @relation(fields: [badge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles  profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, badge_id])
  @@index([badge_id])
  @@schema("public")
}

model user_city_progress {
  user_id         String    @db.Uuid
  city_id         String
  level           Int?      @default(1)
  experience      Int?      @default(0)
  tiles_captured  Int?      @default(0)
  area_controlled Decimal?  @default(0) @db.Decimal
  reputation      Int?      @default(0)
  score           Int?      @default(0)
  last_active_at  DateTime? @default(now()) @db.Timestamptz(6)
  joined_at       DateTime? @default(now()) @db.Timestamptz(6)
  profiles        profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, city_id])
  @@index([city_id, score(sort: Desc)], map: "idx_ucp_score")
  @@schema("public")
}

model territory_hp_logs {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  territory_id String
  attacker_id  String    @db.Uuid
  damage       Int
  attacked_at  DateTime? @default(now()) @db.Timestamptz(6)
  attack_date  DateTime  @default(dbgenerated("CURRENT_DATE")) @db.Date
  territories  territories @relation(fields: [territory_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([territory_id, attacker_id, attack_date])
  @@index([territory_id], map: "idx_hp_logs_territory")
  @@schema("public")
}

model territory_owner_change_logs {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  territory_id   String
  previous_owner String?   @db.Uuid
  new_owner      String    @db.Uuid
  changed_at     DateTime? @default(now()) @db.Timestamptz(6)
  territories    territories @relation(fields: [territory_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([territory_id, changed_at(sort: Desc)], map: "idx_ocl_territory_time")
  @@schema("public")
}

model user_missions {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  mission_id String
  progress   Int?      @default(0)
  status     String?   @default("ongoing")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  claimed_at DateTime? @db.Timestamptz(6)
  missions   missions  @relation(fields: [mission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, mission_id])
  @@index([user_id], map: "idx_user_missions_user_id")
  @@index([mission_id])
  @@schema("public")
}

model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)

  @@schema("public")
}

model user_locations {
  id         String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String                   @db.Uuid
  location   Unsupported("geometry")?
  updated_at DateTime?                @default(now()) @db.Timestamptz(6)

  @@index([location], map: "idx_user_locations_location", type: Gist)
  @@index([user_id])
  @@schema("public")
}

enum club_status {
  pending
  active
  rejected
  suspended

  @@schema("public")
}

model profile_likes {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  likerId   String   @map("liker_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      profiles @relation("profile_likes_user", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  liker     profiles @relation("profile_likes_liker", fields: [likerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, likerId])
  @@index([userId])
  @@index([likerId])
  @@schema("public")
}

model blocked_users {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  blockerId String   @map("blocker_id") @db.Uuid
  blockedId String   @map("blocked_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  blocker   profiles @relation("blocked_users_blocker", fields: [blockerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  blocked   profiles @relation("blocked_users_blocked", fields: [blockedId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@schema("public")
}

model backgrounds {
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  previewUrl      String?            @map("preview_url")
  imageUrl        String             @map("image_url")
  isDefault       Boolean            @default(false) @map("is_default")
  conditionType   String?            @default("free") @map("condition_type")
  conditionValue  Int?               @default(0) @map("condition_value")
  priceCoins      Int?               @default(0) @map("price_coins")
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  userBackgrounds user_backgrounds[]

  @@schema("public")
}

model user_backgrounds {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String      @map("user_id") @db.Uuid
  backgroundId String      @map("background_id") @db.Uuid
  acquiredAt   DateTime    @default(now()) @map("acquired_at") @db.Timestamptz(6)
  profiles     profiles    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  backgrounds  backgrounds @relation(fields: [backgroundId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, backgroundId])
  @@index([userId])
  @@schema("public")
}

model Task {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique // e.g., "daily_run_1km"
  type        String // DAILY, WEEKLY
  title       String
  description String
  targetValue Int      @map("target_value")
  unit        String // "meters", "count", "times"
  reward      Json // { coins: 100, xp: 20 }
  condition   String // Strategy key: DISTANCE_SUM, PACE_LIMIT, GRID_COUNT, etc.
  isVisible   Boolean  @default(true) @map("is_visible")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  userTaskProgress UserTaskProgress[]

  @@map("tasks")
  @@schema("public")
}

model UserTaskProgress {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  taskId       String    @map("task_id") @db.Uuid
  currentValue Int       @default(0) @map("current_value")
  status       String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, CLAIMED
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user profiles @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId, expiresAt])
  @@index([userId, status])
  @@map("user_task_progress")
  @@schema("public")
}

model activity_likes {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @db.Uuid
  activity_type String // 'run', 'badge'
  target_id     String
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  profiles profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, activity_type, target_id])
  @@index([target_id, activity_type])
  @@schema("public")
}

model activity_comments {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @db.Uuid
  activity_type String // 'run', 'badge'
  target_id     String
  content       String
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  profiles profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([target_id, activity_type])
  @@schema("public")
}

model posts {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String   @db.Uuid
  content     String?
  source_type String // 'TEXT', 'RUN', 'ACHIEVEMENT'
  media_urls  String[] @default([]) // Array of image/video URLs
  source_id   String?
  visibility  String   @default("PUBLIC") // 'PUBLIC', 'FRIENDS_ONLY', 'CLUB_ONLY', 'PRIVATE'
  status      String   @default("ACTIVE") // 'ACTIVE', 'DELETED'
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  user     profiles        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  likes    post_likes[]
  comments post_comments[]
  reports  post_reports[]

  @@index([user_id, created_at(sort: Desc)])
  @@index([visibility, status, created_at(sort: Desc)])
  // 偏函数索引 idx_posts_friends_feed 通过 raw SQL 维护，见 prisma/migrations/add_posts_friends_feed_index.sql
  @@schema("public")
}

model post_likes {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  post_id    String   @db.Uuid
  user_id    String   @db.Uuid
  is_read    Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)

  post posts    @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([post_id, user_id])
  @@index([post_id])
  @@schema("public")
}

model post_comments {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  post_id    String   @db.Uuid
  user_id    String   @db.Uuid
  content    String
  status     String   @default("ACTIVE")
  is_read    Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)

  post posts    @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([post_id, status, created_at(sort: Asc)])
  @@schema("public")
}

model store_items {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String
  description             String?
  price                   Int
  inventory_count         Int      @default(-1)
  purchase_limit_per_user Int      @default(1)
  is_active               Boolean  @default(true)
  created_at              DateTime @default(now()) @db.Timestamptz(6)

  purchases user_purchases[]

  @@schema("public")
}

model user_purchases {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  idempotency_key String   @unique
  user_id         String   @db.Uuid
  item_id         String   @db.Uuid
  status          String   @default("PENDING") // 'PENDING', 'COMPLETED', 'FAILED'
  failure_reason  String?
  season_id       String?  @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  user profiles    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  item store_items @relation(fields: [item_id], references: [id], onDelete: Cascade)

  @@unique([user_id, item_id, season_id])
  @@index([user_id])
  @@schema("public")
}

model post_reports {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  post_id    String   @db.Uuid
  user_id    String   @db.Uuid
  reason     String
  status     String   @default("PENDING") // 'PENDING', 'REVIEWED', 'DISMISSED'
  created_at DateTime @default(now()) @db.Timestamptz(6)

  post posts    @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([post_id, user_id])
  @@index([post_id])
  @@schema("public")
}

model leaderboard_snapshots {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  season_id    String   @db.Uuid
  dimension    String // e.g., 'REGION', 'CLUB', 'DISTANCE'
  rank_data    Json     @db.Json
  generated_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([season_id, dimension])
  @@schema("public")
}
