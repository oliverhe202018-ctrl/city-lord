generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

model profiles {
  id                                            String               @id @db.Uuid
  nickname                                      String?
  avatar_url                                    String?
  level                                         Int?                 @default(1)
  current_exp                                   Int?                 @default(0)
  max_exp                                       Int?                 @default(1000)
  stamina                                       Int?                 @default(100)
  max_stamina                                   Int?                 @default(100)
  total_area                                    Float?               @default(0)
  created_at                                    DateTime             @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  updated_at                                    DateTime             @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  club_id                                       String?              @db.Uuid
  xp                                            Int?                 @default(0)
  total_distance_km                             Float?               @default(0)
  coins                                         Int?                 @default(0)
  faction                                       String?
  last_faction_change_at                        DateTime?            @db.Timestamptz(6)
  invited_by                                    String?              @db.Uuid
  path_color                                    String?              @default("#3B82F6")
  fill_color                                    String?              @default("#3B82F6")
  province                                      String?
  referral_code                                 String?              @unique
  referrer_id                                   String?              @db.Uuid
  badges                                        String[]             @default([])
  
  challenges_challenges_creator_idToprofiles    challenges[]         @relation("challenges_creator_idToprofiles")
  challenges_challenges_target_idToprofiles     challenges[]         @relation("challenges_target_idToprofiles")
  club_members                                  club_members[]
  clubs_clubs_owner_idToprofiles                clubs[]              @relation("clubs_owner_idToprofiles")
  friendships_friendships_friend_idToprofiles   friendships[]        @relation("friendships_friend_idToprofiles")
  friendships_friendships_user_idToprofiles     friendships[]        @relation("friendships_user_idToprofiles")
  messages                                      messages[]
  notifications                                 notifications[]
  clubs_profiles_club_idToclubs                 clubs?               @relation("profiles_club_idToclubs", fields: [club_id], references: [id], onUpdate: NoAction)
  profiles_profiles_invited_byToprofiles        profiles?            @relation("profiles_invited_byToprofiles", fields: [invited_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_profiles_profiles_invited_byToprofiles  profiles[]           @relation("profiles_invited_byToprofiles")
  profiles_profiles_referrer_idToprofiles       profiles?            @relation("profiles_referrer_idToprofiles", fields: [referrer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_profiles_profiles_referrer_idToprofiles profiles[]           @relation("profiles_referrer_idToprofiles")
  room_participants                             room_participants[]
  rooms                                         rooms[]
  route_plans                                   route_plans[]
  runs                                          runs[]
  territories                                   territories[]
  training_plans                                training_plans[]
  user_city_progress                            user_city_progress[]
  user_season_stats                             user_season_stats[]
  user_achievements                             user_achievements[]
  user_badges                                   user_badges[]
  user_missions                                 user_missions[]

  @@index([club_id], map: "idx_profiles_club_id")
  @@index([faction], map: "idx_profiles_faction")
  @@index([invited_by], map: "idx_profiles_invited_by")
  @@index([referrer_id])
  @@map("profiles")
  @@schema("public")
}

model DailyStat {
  id               String   @id @default(cuid())
  date             DateTime @unique
  redCount         Int
  blueCount        Int
  totalTerritories Int
  createdAt        DateTime @default(now())

  @@schema("public")
}

model route_plans {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String    @db.Uuid
  name           String?
  waypoints      Json?     @db.Json
  geometry       Json?     @db.Json
  distance       Float?    @default(0)
  estimated_time Int?      @default(0)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  capture_area   Float?    @default(0)
  profiles       profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model training_plans {
  id                 String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String               @db.Uuid
  goal               String?
  level              String?
  start_date         DateTime?            @db.Timestamptz(6)
  duration_weeks     Int?
  created_at         DateTime?            @default(now()) @db.Timestamptz(6)
  scheduled_workouts scheduled_workouts[]
  profiles           profiles             @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model seasons {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  start_date        DateTime            @db.Timestamptz(6)
  end_date          DateTime            @db.Timestamptz(6)
  is_active         Boolean             @default(false)
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)
  user_season_stats user_season_stats[]

  @@schema("public")
}

model user_season_stats {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id   String   @db.Uuid
  season_id String   @db.Uuid
  score     Int      @default(0)
  rank      Int?
  seasons   seasons  @relation(fields: [season_id], references: [id], onDelete: Cascade)
  profiles  profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, season_id])
  @@index([season_id])
  @@schema("public")
}

model scheduled_workouts {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  plan_id         String         @db.Uuid
  day_offset      Int?
  target_distance Float?
  target_pace     String?
  is_completed    Boolean?       @default(false)
  training_plans  training_plans @relation(fields: [plan_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([plan_id])
  @@schema("public")
}

model admin_logs {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  admin_id   String    @db.Uuid
  action     String
  target_id  String?   @db.Uuid
  details    String?

  @@index([admin_id])
  @@schema("public")
}

model app_admins {
  id         String    @id @db.Uuid
  role       String?   @default("moderator")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

model badges {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                    String        @unique
  name                    String
  description             String?
  icon_name               String?
  category                String?
  condition_value         Int?
  tier                    String?       @default("bronze")
  requirement_type        String?
  requirement_value       Decimal?      @db.Decimal
  icon_path               String?
  level                   String?
  requirement_description String?
  user_badges             user_badges[]

  @@schema("public")
}

model challenges {
  id                                       String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type                                     String
  creator_id                               String    @db.Uuid
  target_id                                String    @db.Uuid
  distance                                 Float?
  duration                                 String?
  reward_xp                                Int?      @default(0)
  status                                   String?   @default("pending")
  created_at                               DateTime  @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  expires_at                               DateTime? @db.Timestamptz(6)
  profiles_challenges_creator_idToprofiles profiles  @relation("challenges_creator_idToprofiles", fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_challenges_target_idToprofiles  profiles  @relation("challenges_target_idToprofiles", fields: [target_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([creator_id])
  @@index([target_id])
  @@schema("public")
}

model club_members {
  club_id   String   @db.Uuid
  user_id   String   @db.Uuid
  role      String?  @default("member")
  joined_at DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  status    String?  @default("pending")
  clubs     clubs    @relation(fields: [club_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles  profiles @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([club_id, user_id])
  @@index([user_id])
  @@schema("public")
}

model clubs {
  id                                String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                              String         @unique
  description                       String?
  owner_id                          String?        @db.Uuid
  created_at                        DateTime       @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  status                            club_status?   @default(pending)
  audit_reason                      String?
  province                          String?
  total_area                        Decimal?       @default(0) @db.Decimal
  avatar_url                        String?
  is_public                         Boolean?       @default(true)
  level                             String?        @default("1")
  rating                            Decimal?       @default(0) @db.Decimal
  member_count                      Int?           @default(1)
  territory                         String?        @default("0")
  club_members                      club_members[]
  profiles_clubs_owner_idToprofiles profiles?      @relation("clubs_owner_idToprofiles", fields: [owner_id], references: [id], onUpdate: NoAction)
  profiles_profiles_club_idToclubs  profiles[]     @relation("profiles_club_idToclubs")
  runs                              runs[]
  
  @@index([owner_id], map: "idx_clubs_owner_id")
  @@index([province])
  @@schema("public")
}

model ProvinceStat {
  id                 Int      @id @default(autoincrement())
  provinceName       String   @unique
  totalTerritoryArea Float
  updatedAt          DateTime @updatedAt

  @@schema("public")
}

model faction_balance_configs {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  updated_at           DateTime? @default(now()) @db.Timestamptz(6)
  imbalance_threshold  Decimal?  @default(0.1) @db.Decimal
  underdog_multiplier  Decimal?  @default(1.0) @db.Decimal
  auto_balance_enabled Boolean?  @default(true)
  manual_buff_target   String?   @default("none")

  @@schema("public")
}

model FactionStatsCache {
  id         Int      @id @default(autoincrement())
  red_area   Float    @default(0)
  blue_area  Float    @default(0)
  updated_at DateTime @default(now()) @updatedAt

  @@schema("public")
}

model faction_stats_snapshot {
  id         String   @id
  blue_area  Float    @default(0)
  red_area   Float    @default(0)
  updated_at DateTime @default(now())

  @@schema("public")
}

model friendships {
  id                                       String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id                                  String   @db.Uuid
  friend_id                                String   @db.Uuid
  status                                   String?  @default("pending")
  created_at                               DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  profiles_friendships_friend_idToprofiles profiles @relation("friendships_friend_idToprofiles", fields: [friend_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_friendships_user_idToprofiles   profiles @relation("friendships_user_idToprofiles", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, friend_id])
  @@index([friend_id], map: "idx_friendships_friend_id")
  @@schema("public")
}

model messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @db.Uuid
  content    String?
  is_read    Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  sender_id  String?   @db.Uuid
  profiles   profiles? @relation(fields: [sender_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([sender_id], map: "idx_messages_sender_id")
  // @@index([user_id])
  @@index([user_id, is_read], map: "idx_messages_user_unread")
  @@schema("public")
}

model mission_configs {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  code          String    @unique
  title         String
  description   String?
  points_reward Int       @default(0)
  is_active     Boolean?  @default(true)
  frequency     String?   @default("daily")

  @@schema("public")
}

model missions {
  id                String          @id @default(dbgenerated("gen_random_uuid()"))
  title             String
  description       String?
  type              String
  target_value      Int?            @default(1)
  reward_amount     Int?            @default(100)
  created_at        DateTime?       @default(now()) @db.Timestamptz(6)
  frequency         String?         @default("one_time")
  reward_coins      Int?            @default(0)
  reward_xp         Int?            @default(0)
  target            Int?            @default(1)
  reward_experience Int?            @default(0)
  target_count      Int?            @default(1)
  user_missions     user_missions[]

  @@schema("public")
}

model notifications {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  title      String
  body       String?
  type       String?
  data       Json?
  is_read    Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model room_messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  room_id    String    @db.Uuid
  user_id    String    @db.Uuid
  content    String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  rooms      rooms     @relation(fields: [room_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([room_id])
  @@index([user_id])
  @@schema("public")
}

model room_participants {
  room_id         String   @db.Uuid
  user_id         String   @db.Uuid
  joined_at       DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  total_score     Int?     @default(0)
  territory_area  Decimal? @default(0.00) @db.Decimal(10, 2)
  territory_ratio Decimal? @default(0.00) @db.Decimal(5, 2)
  stolen_lands    Int?     @default(0)
  lost_lands      Int?     @default(0)
  rivals_defeated Int?     @default(0)
  growth_rate     Decimal? @default(0.00) @db.Decimal(5, 2)
  status          String?  @default("active")
  role            String?  @default("member")
  rooms           rooms    @relation(fields: [room_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles        profiles @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([room_id, user_id])
  @@index([room_id, territory_ratio(sort: Desc)], map: "idx_room_participants_ratio")
  @@index([room_id, total_score(sort: Desc)], map: "idx_room_participants_score")
  @@index([user_id])
  @@schema("public")
}

model rooms {
  id                      String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  host_id                 String?             @db.Uuid
  name                    String
  target_distance_km      Decimal?            @db.Decimal
  target_duration_minutes Int?
  max_participants        Int?                @default(10)
  is_private              Boolean?            @default(false)
  password                String?
  status                  String?             @default("waiting")
  created_at              DateTime            @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  is_banned               Boolean?            @default(false)
  allow_chat              Boolean?            @default(true)
  icon_url                String?
  description             String?
  allow_imports           Boolean?            @default(true)
  avatar_url              String?
  category                String?
  invite_code             String?
  allow_member_invite     Boolean?            @default(true)
  room_messages           room_messages[]
  room_participants       room_participants[]
  profiles                profiles?           @relation(fields: [host_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([host_id], map: "idx_rooms_host_id")
  @@schema("public")
}

model runs {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @db.Uuid
  club_id    String?   @db.Uuid
  area       Decimal   @default(0) @db.Decimal
  duration   Int       @default(0)
  province   String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  status     String?   @default("active")
  path       Json?     @db.Json
  distance   Float?    @default(0)
  clubs      clubs?    @relation(fields: [club_id], references: [id], onUpdate: NoAction)
  profiles   profiles? @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([club_id], map: "idx_runs_club_id")
  @@index([user_id])
  @@schema("public")
}

model territories {
  id                 String                   @id
  city_id            String
  owner_id           String                   @db.Uuid
  captured_at        DateTime?                @default(now()) @db.Timestamptz(6)
  last_maintained_at DateTime?                @default(now()) @db.Timestamptz(6)
  health             Int?                     @default(100)
  level              Int?                     @default(1)
  geojson            Unsupported("geometry")?
  h3_index           String?
  status             String?                  @default("active")
  profiles           profiles                 @relation(fields: [owner_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([city_id], map: "idx_territories_city_id")
  @@index([owner_id], map: "idx_territories_owner_id")
  @@schema("public")
}

model user_achievements {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String?   @db.Uuid
  achievement_id String?
  unlocked_at    DateTime? @default(now()) @db.Timestamptz(6)
  profiles       profiles? @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id], map: "idx_user_achievements_user_id")
  @@schema("public")
}

model user_badges {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id   String    @db.Uuid
  badge_id  String    @db.Uuid
  earned_at DateTime? @default(now()) @db.Timestamptz(6)
  badges    badges    @relation(fields: [badge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles  profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, badge_id])
  @@index([badge_id])
  @@schema("public")
}

model user_city_progress {
  user_id         String    @db.Uuid
  city_id         String
  level           Int?      @default(1)
  experience      Int?      @default(0)
  tiles_captured  Int?      @default(0)
  area_controlled Decimal?  @default(0) @db.Decimal
  reputation      Int?      @default(0)
  last_active_at  DateTime? @default(now()) @db.Timestamptz(6)
  joined_at       DateTime? @default(now()) @db.Timestamptz(6)
  profiles        profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, city_id])
  @@schema("public")
}

model user_missions {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  mission_id String
  progress   Int?      @default(0)
  status     String?   @default("ongoing")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  claimed_at DateTime? @db.Timestamptz(6)
  missions   missions  @relation(fields: [mission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, mission_id])
  @@index([user_id], map: "idx_user_missions_user_id")
  @@index([mission_id])
  @@schema("public")
}

model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)

  @@schema("public")
}

model user_locations {
  id         String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String                   @db.Uuid
  location   Unsupported("geometry")?
  updated_at DateTime?                @default(now()) @db.Timestamptz(6)

  @@index([location], map: "idx_user_locations_location", type: Gist)
  @@index([user_id])
  @@schema("public")
}

enum club_status {
  pending
  active
  rejected
  suspended

  @@schema("public")
}
