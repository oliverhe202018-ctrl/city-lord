# City Lord - 城市领主

City Lord 是一款结合真实地理位置（LBS）的跑步领地争夺游戏。玩家通过在现实世界中跑步来占领地图上的六边形地块，加入阵营（赤红先锋 vs 蔚蓝联盟），与同城的跑者竞争，扩张领地，赢取荣誉。

## 📅 更新日志 (Changelog)

### 2026-02-03: 阵营系统增强与 UI/UX 优化 (Current)

**主要更新内容：**

1.  **🌍 动态城市数据 (Dynamic City Support)**
    *   **问题**：旧版本仅支持预设的地级市，缺少区/县级详细数据（如邵阳县 430528）。
    *   **修复**：集成了高德地图 API (`AMap.DistrictSearch`)，实现了行政区划的动态获取。现在游戏可以自动识别并加载全国任意区县的边界数据，无需手动维护数据库。
    *   **排名优化**：实现了“地级市统一排名”与“区县独立排名”的双层逻辑。

2.  **⚔️ 阵营系统 (Faction System 2.0)**
    *   **新功能**：实现了阵营平衡机制。
    *   **弱势加成**：当一方阵营人数处于劣势时，系统会自动计算加成比例（最高 200%）。该加成会直接应用到任务奖励（XP 和金币）中。
    *   **可视化对比**：在个人资料页新增了“阵营战况”卡片，直观展示红蓝双方的人数对比和领地势力（Area）对比。领地势力条已包含加成权重，体现“以少胜多”的潜力。
    *   **后端优化**：新增 RPC 函数 `get_faction_stats_rpc` 以高效聚合阵营数据。

3.  **🔐 认证系统 (Custom Authentication)**
    *   **新功能**：移除了 Supabase 默认的邮件确认链接，改为使用自定义的 6 位数字验证码（通过 Nodemailer + 126.com SMTP 发送）。
    *   **体验优化**：优化了注册流程，修复了注册后“Profile not found”的竞态条件错误，实现了账号创建时的自愈（Self-healing）机制。

4.  **👤 用户界面 (UI/UX)**
    *   **个人资料页**：
        *   头像现在支持点击直接编辑，无需寻找隐藏按钮。
        *   修复了头像图片域名 (`api.dicebear.com`) 的加载权限问题。
        *   微调了等级徽章的位置，避免遮挡头像。
    *   **城市选择器**：重新设计了城市切换侧边栏，增加了“热门城市”快捷入口，并按省份分组展示历史访问城市。
    *   **注册/登录页**：修复了暗色模式下的 UI 可见性问题，优化了按钮和 Tab 的交互反馈。

## 🚀 核心功能

*   **🏃 跑步占领**：实时追踪跑步轨迹，将轨迹覆盖的六边形地块转化为个人领地。
*   **🗺️ 六边形地图**：基于 H3 索引的高性能动态地图，支持迷雾系统。
*   **🤝 社交互动**：好友系统、实时动态、以及即将推出的俱乐部功能。
*   **🏆 成就系统**：丰富的勋章墙和排行榜，记录你的每一次突破。

## 🛠️ 技术栈

*   **前端**：Next.js 14 (React), Tailwind CSS, Framer Motion, Lucide Icons
*   **地图**：高德地图 JS API (AMap), H3-js (六边形网格)
*   **后端/数据库**：Supabase (PostgreSQL, Auth, Realtime)
*   **移动端适配**：Capacitor (Android/iOS)

## 📦 快速开始

1.  **安装依赖**
    ```bash
    npm install
    # or
    yarn install
    ```

2.  **配置环境变量**
    复制 `.env.example` 为 `.env.local` 并填入 Supabase 和高德地图的 Key。

3.  **启动开发服务器**
    ```bash
    npm run dev
    ```

4.  **访问**
    打开浏览器访问 `http://localhost:3000`

---
*Created by Trae AI Assistant*
